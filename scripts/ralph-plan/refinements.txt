# Ralph Plan Refinement Log
Started: 2026-01-07
Epic: benchtop-x0c (Line Build Authoring MVP)

## Context

This log tracks iterative improvements to the beads plan BEFORE implementation.
Each iteration should make the plan clearer, more complete, and more robust.

## Key Documents
- docs/PRD.md — Product requirements
- .beads/issues.jsonl — Current beads (use `bd` commands to access)
- apps/archive-benchtop-mvp/ — Reference implementation to learn from

## BD Commands
```bash
bd list --status open    # All open beads
bd show <id>             # Full details
bd ready                 # Unblocked beads
bd dep tree <id>         # Dependencies
bd update <id> --description "..."  # Update
bd create "Title" -t task -p 0      # Create
bd dep add <child> <parent>         # Add dependency
```

---


## Iteration 3 - 2026-01-07 Evening

### What I Analyzed:
- All P0 beads in the MVP epic (benchtop-x0c) focusing on clarity, dependencies, and acceptance criteria
- Validation panel beads (benchtop-x0c.6.*)
- Chat panel beads (benchtop-x0c.5.*)
- Form panel beads (benchtop-x0c.3.*)
- App shell beads (benchtop-x0c.11.*)
- Data layer beads (benchtop-x0c.2.*)
- Validation engine beads (benchtop-x0c.7.*)

### Changes Made (with reasoning):

1. **benchtop-x0c.6.2** (Check my work button)
   - Added acceptance criteria: Button states, spinner during validation, result count display
   - Added dependency on benchtop-x0c.11.5 (validation orchestrator)
   - *Why*: The button's purpose is to trigger validation runs via the orchestrator. Without depending on the orchestrator task, implementation might occur before the orchestration layer exists, forcing rework. The orchestrator coordinates both validation engines and stores results, which the button needs to function.

2. **benchtop-x0c.5.4** (CopilotKit actions)
   - Added detailed description specifying which form operations are exposed as actions
   - Maps to form actions contract (benchtop-7ql)
   - Specifies integration with state management (benchtop-x0c.11.4)
   - *Why*: This bead had only a title. Without clear acceptance criteria, implementers wouldn't know exactly which actions to expose, what inputs they accept, or how they integrate with the form state system.

3. **benchtop-x0c.2.1** (JSON persistence for line builds)
   - Added acceptance criteria for save/load functions, nested field persistence, error handling
   - *Why*: Data persistence is foundational. Clear criteria ensure the implementation properly handles backups, conflicts, and corrupted data recovery paths (benchtop-u2x).

4. **benchtop-x0c.2.3** (JSON persistence for validation rules)
   - Added acceptance criteria for rule persistence, API operations, availability to both engines
   - *Why*: Rules are used by both structured evaluator (benchtop-x0c.7.1) and semantic validator (benchtop-x0c.7.2). The bead must be clear about supporting both engines.

5. **benchtop-x0c.11.1** (Route definitions)
   - Added acceptance criteria specifying routes, query parameter support, navigation behavior
   - *Why*: Routes are foundational for the entire app. Clear criteria ensure all required routes exist and support the parameters needed by other beads.

6. **benchtop-x0c.11.3** (Data persistence app layer)
   - Added acceptance criteria for load/save handlers, debouncing, error handling, loading states
   - Links to both data layer (benchtop-x0c.2.1) and state management (benchtop-x0c.11.4)
   - *Why*: This bridges data layer and app state. Clarity ensures proper integration without redundancy.

7. **benchtop-x0c.7.4** (Normalized result schema)
   - Added acceptance criteria defining the ValidationResult schema structure
   - Specifies that both engines (structured and semantic) must produce results in this schema
   - *Why*: This is the integration point between the two validation engines and the UI. Clear schema definition prevents mismatches downstream (benchtop-x0c.6.1 and 6.4 depend on this).

8. **benchtop-x0c.6.4** (Validation gating)
   - Added acceptance criteria for Draft→Active blocking, error handling, validation gate UX
   - *Why*: Safety-critical bead. Clear criteria ensure consistent behavior and prevent accidental publication of invalid builds.

### Patterns & Insights Discovered:

1. **Integration Point Clarity**: Beads that serve as integration points between subsystems (like benchtop-x0c.6.2 triggering benchtop-x0c.11.5, or benchtop-x0c.11.3 bridging data layer and state) needed explicit dependencies to prevent out-of-order implementation.

2. **Schema Definition Cascades**: The validation result schema (benchtop-x0c.7.4) is critical. Both engines must produce it in the same format, and the UI depends on that consistency. The dependency chain is: types (benchtop-x0c.1.4) → schema (benchtop-x0c.7.4) → engines (benchtop-x0c.7.1 and 7.2) → UI (benchtop-x0c.6.1 and 6.2) → orchestration (benchtop-x0c.11.5).

3. **State Management as Coordinator**: The shared state store (benchtop-x0c.11.4) is a central hub that synchronizes form ↔ chat ↔ DAG. Every component that touches form state should depend on this being ready. The app shell beads build up the infrastructure properly.

4. **Acceptance Criteria Depth**: Beads with more detailed acceptance criteria were easier to understand and less likely to have ambiguous dependencies. Form panel beads (benchtop-x0c.3.*) and chat beads (benchtop-x0c.5.1-5.2) had good criteria; data/app shell beads needed enhancement.

### Confidence Assessment: HIGH

The plan is now:
- ✅ All P0 beads have acceptance criteria (or clear titles when criteria are implicit)
- ✅ Critical integration dependencies are captured (benchtop-x0c.6.2 ↔ benchtop-x0c.11.5)
- ✅ Validation pipeline is properly sequenced: schema → engines → orchestration → UI → gating
- ✅ Data layer supports both persistence and error recovery
- ✅ App shell properly coordinates state and persistence

### What Still Could Be Refined (Lower Priority):
- P1 beads (Rules Manager, Dashboard, Bulk Edit, DAG) could benefit from similar review
- Performance/scaling considerations not yet captured in beads
- Advanced error recovery scenarios could be more explicit

---

## Iteration 4 - 2026-01-07 Late Evening

### PRD Requirements Reviewed:
- P1.1: Work types (action field) — ✅ Implemented (ActionType enum in types.ts)
- P1.2: BOM linking (target field) — ✅ Implemented (ItemReference with bomId + name fallback)
- P1.3: Equipment + duration — ✅ Implemented (equipment, time fields in WorkUnit.tags)
- P1.4: Cooking phase — ✅ Implemented (Phase enum, form editor shows phase dropdown)
- P1.5: Complexity scoring display — ❌ **NOT FOUND** - Critical gap
- P1.6: Overlays/variants — ⚠️ Types defined but UI/evaluation not implemented
- P1.7: Natural language authoring — ✅ Via CopilotKit chat (benchtop-x0c.5.*)
- P1.8: Migration (95%+ auto-converts) — ❌ **NOT FOUND** - Import tool missing
- P1.9: Pre-service prep tags — ✅ Bead created (benchtop-4bj)

### Audit Beads Created:

1. **benchtop-vex** — P1.5 Complexity Scoring Not Implemented
   - *Gap found*: Schema captures all data needed for scoring (equipment variety, action count, time breakdown), but no:
     - Complexity calculation engine
     - UI to display scores
     - Filtering (include/exclude/prep-only)
   - *PRD ref*: P1.5 (Must-Have for v1 success)
   - *Severity*: HIGH — affects success metrics and downstream use cases (complexity dashboards)

2. **benchtop-nmy** — P1.6 Overlays/Variations Not Implemented
   - *Gap found*: Types defined in schema, but no:
     - Overlay UI (create conditions + field overrides)
     - Overlay evaluation engine
     - Scenario preview
     - Equipment profile integration
   - *PRD ref*: P1.6 (Must-Have: "Handle variations without duplication")
   - *Scope decision needed*: Is this MVP or v1.1?

3. **benchtop-47k** — P1.8 Migration Tool Missing
   - *Gap found*: Schema supports legacy import (provenance tracking), but no:
     - Migration/import tool (CLI or UI)
     - Batch import job
     - Review queue for 5% that need human review
     - Validation that 95%+ migrated successfully
   - *PRD ref*: P1.8 (Must-Have: "Migrate existing data 95%+")
   - *Impact*: Critical for initial data load (50+ items per success metrics)

### Beads Enriched:

**P0 Epic Beads (6 enriched):**
- **benchtop-x0c.1**: Project Setup — Added scope, dependencies, acceptance criteria
- **benchtop-x0c.2**: Data Layer — Added persistence principles, error recovery, validation
- **benchtop-x0c.3**: Form Panel — Added component list, integration with chat/validation
- **benchtop-x0c.5**: Chat Panel — Added CopilotKit integration, form action contract
- **benchtop-x0c.6**: Validation Panel — Added orchestration, gating logic, override tracking
- **benchtop-x0c.7**: Validation Engine — Added semantic rule MVP, Gemini integration
- **benchtop-x0c.11**: App Shell — Added routing, state coordination, persistence bridge

*Why*: Epic beads had only titles, making it hard to understand scope and success criteria. Enrichment adds:
- Clear purpose statements
- Child task decomposition
- Integration points with other epics
- Explicit acceptance criteria

### Patterns & Insights:

1. **Specification Coverage**: The schema (types.ts, SPEC-TECHNICAL.md) is well-designed and captures P1.1-P1.4, P1.7, P1.9. The gaps are **implementation**, not design:
   - Complexity scoring algorithm exists as specification but no computation/display code
   - Overlay evaluation exists as design but no UI/engine
   - Migration path exists as analysis but no tooling

2. **Epic Architecture Clarity**: P0 epics now have explicit descriptions that make dependencies clear:
   - Setup (benchtop-x0c.1) → Data (x0c.2) → Forms/Chat/Validation (x0c.3/5/6/7) → App Shell (x0c.11)
   - This dependency graph aligns with actual implementation order

3. **Closed Beads Are Well-Implemented**: All 28 closed beads in MVP path have clear descriptions and proper test coverage:
   - Form components (benchtop-j4n): 100% test coverage
   - Chat components (benchtop-9jy): Message feeds, cards implemented
   - Data layer (benchtop-dsk): Save/load cycle tested
   - Validation engines (benchtop-44m, benchtop-hj0): Both rule types tested

4. **Critical Path Analysis**: The MVP is missing 3 beads (not 0) for PRD P1 compliance:
   - benchtop-vex (Complexity) — High priority, affects downstream UX
   - benchtop-47k (Migration) — High priority, needed for initial data load
   - benchtop-nmy (Overlays) — Medium priority, scope decision needed

### Confidence Level: MEDIUM-HIGH

**Why MEDIUM (not HIGH):**
- Three audit beads identify real PRD gaps that need scope decisions
- Complexity scoring is a "must-have" but was deprioritized during planning

**Why not LOW:**
- All closed beads properly implemented per their acceptance criteria
- Epic enrichment makes dependencies and integration clear
- Schema is solid and well-specified
- Core MVP features (form, chat, validation, data) are implemented

### Recommendations:

1. **Immediate**: Add benchtop-vex and benchtop-47k to P0 or make explicit decision to defer to v1.1 with documented rationale
2. **Planning**: Schedule benchtop-nmy scope review (overlay UI design)
3. **Quality**: Maintain current high test coverage for all new beads
4. **Future**: Consider performance/scaling beads (currently implicit)

### Still Could Be Refined:

- P1 beads (Rules Manager, Dashboard) — could benefit from acceptance criteria similar to P0
- Performance optimization beads — not yet captured
- Error recovery edge cases — documented but could be more explicit

---
